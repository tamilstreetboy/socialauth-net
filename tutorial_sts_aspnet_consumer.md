# Using SocialAuth.NET STS   with ASP.NET STS Consumer #
This tutorial explains how you can quickly create a STS consumer to consume SocialAuth.NET STS service.

## Pre-requisite ##
It is assumed that you have already setup a running STS provider. If you don't have any STS available, [follow this tutorial](tutorial_creating_sts.md) to create one.

## Step by Step Instructions ##

1.	Open Visual Studio 2010 and select **File > New Website**

2.	From the templates option, select ASP.NET Claim aware Website (This option would appear only if you have installed WIF SDK for Visual Studio).


http://socialauth-net.googlecode.com/svn/wiki/images/createconsumerproject.PNG


> Specify Path and create a new website called “SocialAuthSTSConsumer”

This creates a new project with following files.

> http://socialauth-net.googlecode.com/svn/wiki/images/consumerproject.PNG

3.	Right Click on project and select Add STS Reference option

> http://socialauth-net.googlecode.com/svn/wiki/images/addstsreference.PNG
This option provides UI to specify STS Service.

4.	If you wish to host this (STS consumer) application in IIS with a different URL (than autogenerated localhost URL), replace Application URI with it. Otherwise, just press Next without any change.

> http://socialauth-net.googlecode.com/svn/wiki/images/addstsreference1.PNG

5.	If Clicking Next prompts following, select Yes:

> http://socialauth-net.googlecode.com/svn/wiki/images/addstsreference2.PNG

6.	Next screen in this wizard is where you link your STS consumer to STS provider.

Select **Use an existing STS** option and specify FederationMetadata.xml location. When you creat a STS provider website, this file is automatically created by WIF and hosted as YouSTSHost/FederationMetadata/2007-06/FederationMetadata.xml.

For example, If you've created STS using our "Create SocialAuth.NET STS" tutorial, path should be http://opensource.brickred.com/SocialAuthSTS/FederationMetadata/2007-06/FederationMetadata.xml

http://socialauth-net.googlecode.com/svn/wiki/images/addstsreference3.PNG

First part of the URL (http://opensource.brickred.com/SocialAuthSTS) may need replacement with the URL of your STS Service.

After specifying STS WS-Federation path, click on Test Location to verify that you’ve specified valid path. This should open xml file in browser.
Click Next then.

7.	If STS is not hosted on an https protocol, you would see following prompt:

> http://socialauth-net.googlecode.com/svn/wiki/images/addstsreference4.PNG

Select Yes.

8.	In next wizard screen, click Next.

> http://socialauth-net.googlecode.com/svn/wiki/images/addstsreference5.PNG


9.	Continue clicking Next in next screen


http://socialauth-net.googlecode.com/svn/wiki/images/addstsreference6.PNG


10.	Continue clicking Next and finally select Finish.


11.	When we add a STS reference, application reads Federation Metadata.xml and adds several .cs files and Metadata file to application. It also makes changes in Web.Config to add URL of STS provider site. Here exists one minor issue.

If you open Web.Config and try to find “opensource.brickred.com” or the URL you have used for STS provider, you likely wouldn’t find it unless you are hosting provider using localhost (Which should not be the case as Facebook and many other providers do not support localhost). When you create STS provider project, all configurations are made as per dynamic port assigned to application for running using integrated web server. If you try to run consumer application by browsing default.aspx, you would see “This Page cannot be displayed” error.  To fix this:

> a. Open Federation Metada.xml file of your STS provider application (the one you specified in WS-Federation metadata wizard while adding STS reference above) and check for EntityID attribute in first element. This will contain the URL for running project. Copy this URL.

> b. Open Web.Config file of STS consumer application

> c. Replace the URL you copied in first step with the URL you want to host provider with. For example, if you wish to host provider as opensource.brickred.com but the URL you copied in step a. is like http://localhost:xxxx/SocialAuthSTS/ then replace all such entries in web.config with http://opensource.brickred.com/SocialAuthSTS
> Likely, there should be 3 replaces.

12.	Since, we do not wish to allow user to login directly from within consumer application, delete login.aspx.

13.	Compile and Browse default.aspx. It will automatically redirect you to STS provider for login. Once you login using any available OAuth provider, STS will redirect you back to Default.aspx of consumer application with claims. If you face errors, check for troubleshooting tips in following section.


http://socialauth-net.googlecode.com/svn/wiki/images/consumerdefault.PNG

## Troubleshooting tips ##

**Error Description:**<br>
ID4175: The issuer of the security token was not recognized by the IssuerNameRegistry. To accept security tokens from this issuer, configure the IssuerNameRegistry to return a valid name for this issuer.<br>
<br>
<b>Cause:</b><br>
This error occurs due to mismatch of security certificate thumbprint of STS provider and the one mentioned in STS consumer's Web.Config.<br>
<br>
<b>Resolution:</b><br>
<ol><li>Open Web.Config of your consumer application and search for word "thumbprint" to reach trusted issuers registry<br>
</li><li>Open IIS <br>
</li><li>Select the first node (server node)in connection tree on left. Different options with icons will appear on middle frame.<br>
</li><li>Double click on "Server Certificates" option. This will present a list of certificates.<br>
</li><li>Check for STSTestCert certificate and manually type its Certificate Hash somewhere (notepad!)<br>
</li><li>Switch back to your web.config and remove value of thumbrint attribute along with quotes. <br>
</li><li>Type in "" and copy your certificate hash from notepad in between quotes.<br>